#!/bin/sh

cdroot() {
    if ! [ -d ".git" ] && [ "$(pwd)" != "/" ]; then
        cd ..
        cdroot
    fi
}

start_docker_service() {
    if [ -n "$(which systemctl 2>/dev/null)" ]; then
        sudo systemctl start docker
        return
    fi
    if [ -n "$(which service 2>/dev/null)" ]; then
        sudo service docker start
        return
    fi
}

isDockerRunning() {
    if [ -n "$(sudo docker info 2>&1 1>/dev/null)" ] && [ -z "$(sudo docker info)" ]; then
        echo "the docker daemon is not running"
        exit 1
    fi
}

start_docker_service
isDockerRunning

cdroot
pathToProject=$(pwd)
cd docker || exit

if [ -n "$(sudo docker ps | grep elzire)" ]; then
    sudo docker stop elzire && sudo docker rm elzire
fi

if sudo docker build -t elzire .; then
    echo "$pathToProject"
    if [ "$1" = "--dev" ]; then
        sudo docker run --init --rm -it --tmpfs /tmp -e UID="$(id -u)" -e GID="$(id -g)" -v "${pathToProject}":/www --name elzire elzire
    else
        if [ "$1" = "--local" ]; then
            sudo docker run --init --rm -it -p 80:8080 --tmpfs /tmp -e UID="$(id -u)" -e GID="$(id -g)" -v "${pathToProject}":/www --name elzire elzire
        else
            sudo docker run --init --tmpfs /tmp -d -e UID="$(id -u)" -e GID="$(id -g)" -v "${pathToProject}":/www --name elzire elzire
        fi
    fi
fi

cdroot
php bin/console cache:clear --env=prod --no-debug --no-warmup
php bin/console cache:warmup --env=prod
